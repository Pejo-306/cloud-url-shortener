# .github/workflows/build.yml
name: Build SAM application

on:
  pull_request:
    branches: [main]
    paths:
      - 'cloudshortener/**/*.py'
      - 'tests/**/*.py'
      - 'template*.yaml'
      - 'requirements*.txt'
      - 'pyproject.toml'
      - '.github/workflows/**'
  push:
    branches:
      - main
      - 'release-*.*.*'
    paths:
      - 'cloudshortener/**/*.py'
      - 'tests/**/*.py'
      - 'template*.yaml'
      - 'requirements*.txt'
      - 'pyproject.toml'
      - '.github/workflows/**'

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  test:
    # reuse your unit test workflow
    uses: ./.github/workflows/unit_tests.yml
    with:
      python-version: '3.13'
      coverage-threshold: 80
      workdir: .
    secrets: {}  # keep empty

  build:
    # build only on pushes to main or release-*
    # avoid building on PRs - only run tests & coverage on PRs
    if: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release-')) }}
    needs: test
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: pip
          cache-dependency-path: |
            requirements*.txt
            pyproject.toml
            poetry.lock

      - name: Install SAM CLI
        run: |
          pip install aws-sam-cli

      - name: SAM build
        run: sam build --use-container --exclude frontend

      - name: Verify build artifacts
        run: |
          echo "üì¶ Build artifacts created:"
          ls -lah .aws-sam/build/ || echo "‚ùå Build directory not found!"
          echo ""
          echo "üìã Built functions:"
          find .aws-sam/build -name "*.zip" -o -name "*.jar" -o -type d -name "*Function*" | head -20
          echo ""
          echo "üìä Build directory size:"
          du -sh .aws-sam/build/ || echo "‚ùå Could not calculate size"

      - name: SAM validate
        run: sam validate

      # NOTE: Manually installing node.js is only needed on act to upload build artifacts
      - name: Install Node (local/act only)
        if: ${{ env.ACT == 'true' }}
        run: |
          set -eux
          apt-get update
          apt-get install -y ca-certificates curl gnupg
          curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
          apt-get install -y nodejs
          node -v

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: sam-build-artifacts
          path: .aws-sam/build/
          retention-days: 7
